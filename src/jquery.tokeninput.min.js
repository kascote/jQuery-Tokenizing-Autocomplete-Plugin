(function(a){a.fn.tokenInput=function(c,b){var d=a.extend({url:c,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",createText:"Create",searchDelay:300,allowNewValues:false,prePopulateFromInput:false,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",onResult:null,canCreate:false},b);d.classes=a.extend({tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},b.classes);return this.each(function(){var e=new a.TokenList(this,d)})};a.TokenList=function(c,G){var x={BEFORE:0,AFTER:1,END:2};var D={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};var t=[];var o=0;var k=new a.TokenList.Cache();var C;var p=a('<input type="text">').css({outline:"none"}).focus(function(){if(G.tokenLimit==null||G.tokenLimit!=o){g()}}).blur(function(){if(G.allowNewValues){l()}u()}).keydown(function(M){var O;var L;switch(M.keyCode){case D.LEFT:case D.RIGHT:case D.UP:case D.DOWN:if(!a(this).val()){O=h.prev();L=h.next();if((O.length&&O.get(0)===r)||(L.length&&L.get(0)===r)){if(M.keyCode==D.LEFT||M.keyCode==D.UP){v(a(r),x.BEFORE)}else{v(a(r),x.AFTER)}}else{if((M.keyCode==D.LEFT||M.keyCode==D.UP)&&O.length){H(a(O.get(0)))}else{if((M.keyCode==D.RIGHT||M.keyCode==D.DOWN)&&L.length){H(a(L.get(0)))}}}}else{var N=null;if(M.keyCode==D.DOWN||M.keyCode==D.RIGHT){N=a(B).next()}else{N=a(B).prev()}if(N.length){K(N)}return false}break;case D.BACKSPACE:O=h.prev();if(!a(this).val().length){if(r){f(a(r))}else{if(O.length){H(a(O.get(0)))}}return false}else{if(a(this).val().length==1){u()}else{setTimeout(function(){q(false)},5)}}break;case D.TAB:case D.RETURN:case D.COMMA:if(B){y(a(B));return false}else{if(G.allowNewValues){l();return false}}break;case D.ESC:u();return true;default:if(E(M.keyCode)){setTimeout(function(){q(false)},5)}break}return true});var s=a(c).hide().focus(function(){p.focus()}).blur(function(){p.blur()});var r=null;var B=null;var j=a("<ul />").addClass(G.classes.tokenList).insertAfter(s).click(function(M){var L=z(M,"li");if(L&&L.get(0)!=h.get(0)){J(L);return false}else{p.focus();if(r){v(a(r),x.END)}}return true}).mouseover(function(M){var L=z(M,"li");if(L&&r!==this){L.addClass(G.classes.highlightedToken)}}).mouseout(function(M){var L=z(M,"li");if(L&&r!==this){L.removeClass(G.classes.highlightedToken)}}).mousedown(function(M){var L=z(M,"li");if(L){return false}return true});var I=a("<div>").addClass(G.classes.dropdown).insertAfter(j).hide();var h=a("<li />").addClass(G.classes.inputToken).appendTo(j).append(p);F();function F(){li_data=G.prePopulate;if(li_data&&li_data.length){for(var L in li_data){var N=a("<li><p>"+li_data[L].name+"</p> </li>").addClass(G.classes.token).insertBefore(h);a("<span>x</span>").addClass(G.classes.tokenDelete).appendTo(N).click(function(){f(a(this).parent());return false});a.data(N.get(0),"tokeninput",{id:li_data[L].id,name:li_data[L].name});p.val("").focus();u();var M=li_data[L].id+",";s.val(s.val()+M)}}}function E(L){if((L>=48&&L<=90)||(L>=96&&L<=111)||(L>=186&&L<=192)||(L>=219&&L<=222)){return true}else{return false}}function z(M,O){var N=a(M.target);var L=null;if(N.is(O)){L=N}else{if(N.parent(O).length){L=N.parent(O+":first")}}return L}function d(N,L){var M=a("<li><p>"+L+"</p> </li>").addClass(G.classes.token).insertBefore(h);a("<span>x</span>").addClass(G.classes.tokenDelete).appendTo(M).click(function(){f(a(this).parent());return false});a.data(M.get(0),"tokeninput",{id:N,name:L});return M}function y(L){var M=a.data(L.get(0),"tokeninput");e(M)}function e(N){var M=d(N.id,N.name);p.val("").focus();u();var L=N.id+",";s.val(s.val()+L);o++;if(G.tokenLimit!=null&&G.tokenLimit>=o){p.hide();u()}a(s).trigger("tokenadd",{update:w,remove:f,data:N,token:M.get(0)})}function w(O,P){var N=a.data(O,"tokeninput");var L={id:P.id==undefined?N.id:P.id,name:P.name==undefined?N.name:P.name};a.data(O,"tokeninput",P);var M=N.id+",";var Q=L.id+",";s.val(s.val().replace(M,Q))}function l(){return;var L=p.val().toLowerCase();if(L.length>0){var M=a("<li><p>"+L+"</p> </li>").addClass(G.classes.token).insertBefore(h);a("<span>x</span>").addClass(G.classes.tokenDelete).appendTo(M).click(function(){f(a(this).parent());return false});y(M)}}function H(L){L.addClass(G.classes.selectedToken);r=L.get(0);p.val("");u()}function v(M,L){M.removeClass(G.classes.selectedToken);r=null;if(L==x.BEFORE){h.insertBefore(M)}else{if(L==x.AFTER){h.insertAfter(M)}else{h.appendTo(j)}}p.focus()}function J(L){if(r==L.get(0)){v(L,x.END)}else{if(r){v(a(r),x.END)}H(L)}}function f(M){var N=a.data(M.get(0),"tokeninput");M.remove();r=null;p.focus();var O=s.val();var P=O.indexOf(N.id+",");var L=O.indexOf(",",P)+1;if(L>=O.length){s.val(O.slice(0,P))}else{s.val(O.slice(0,P)+O.slice(L,O.length))}o--;if(G.tokenLimit!=null){p.show().val("").focus()}a(s).trigger("tokendelete",{add:e,data:N})}function u(){I.hide().empty();B=null}function i(){if(G.searchingText.length>0){I.html("<p>"+G.searchingText+"</p>").show()}}function g(){I.html("<p>"+G.hintText+"</p>").show()}function n(M,L){return M.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+L+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function A(R,O){if(O.length||G.canCreate){I.empty();var P=a("<ul>").appendTo(I).mouseover(function(T){K(z(T,"li"))}).click(function(T){y(z(T,"li"))}).mousedown(function(T){return false}).hide();var M=new Array();a("."+G.classes.token,j).each(function(T,V){var U=a.data(V,"tokeninput");M[U.name]=1});var Q;for(var N in O){if(O.hasOwnProperty(N)&&!M[O[N].name]){var S=a("<li>"+n(O[N].name,R)+"</li>").appendTo(P);if(N%2){S.addClass(G.classes.dropdownItem)}else{S.addClass(G.classes.dropdownItem2)}if(N==0){Q=S}M[O[N].name]=1;a.data(S.get(0),"tokeninput",{id:O[N].id,name:O[N].name})}}if(G.canCreate&&!M[R]){var L=a("<li>"+G.createText+" '"+R+"'</li>").appendTo(P);if(O.length%2){L.addClass(G.classes.dropdownItem)}else{L.addClass(G.classes.dropdownItem2)}if(O.length==0){Q=L}a.data(L.get(0),"tokeninput",{id:"+"+R,name:R})}if(Q){K(Q)}I.show();P.show()}else{if(G.noResultsText.length>0){I.html("<p>"+G.noResultsText+"</p>").show()}else{u()}}}function K(L){if(L){if(B){b(a(B))}L.addClass(G.classes.selectedDropdownItem);B=L.get(0)}}function b(L){L.removeClass(G.classes.selectedDropdownItem);B=null}function q(L){var M=p.val().toLowerCase();if(M&&M.length){if(r){v(a(r),x.AFTER)}if(M.length>=G.minChars){i();if(L){m(M)}else{clearTimeout(C);C=setTimeout(function(){m(M)},G.searchDelay)}}else{u()}}}function m(M){var L=k.get(M);if(L){A(M,L)}else{var O=G.url.indexOf("?")<0?"?":"&";var N=function(P){if(a.isFunction(G.onResult)){P=G.onResult.call(this,P)}k.add(M,G.jsonContainer?P[G.jsonContainer]:P);A(M,G.jsonContainer?P[G.jsonContainer]:P)};if(G.method=="POST"){a.post(G.url+O+G.queryParam+"="+M,{},N,G.contentType)}else{a.get(G.url+O+G.queryParam+"="+M,{},N,G.contentType)}}}};a.TokenList.Cache=function(c){var e=a.extend({max_size:50},c);var f={};var d=0;var b=function(){f={};d=0};this.add=function(h,g){if(d>e.max_size){b()}if(!f[h]){d++}f[h]=g};this.get=function(g){return f[g]}}})(jQuery);